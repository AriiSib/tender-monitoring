<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head(title='Поиск тендеров')}"></head>
<body class="d-flex flex-column min-vh-100">

<div th:replace="~{fragments/navbar :: navbar}"></div>
<main class='flex-grow-1'>
    <div class='container py-5'>
        <form class='card shadow-sm p-4 mb-5' th:action='@{/api/search}' method='post'
              th:object='${searchFormAttribute}'>
            <input type='hidden' th:field='*{currentPage}'>
            <div class='row g-3'>
                <div class='col-12'>
                    <label class='form-label' for='keyword'>Ключевые слова</label>
                    <input id='keyword' class='form-control' type='text' th:field='*{keyword}'
                           placeholder='Например: уборка помещений, обслуживание'>
                </div>
                <div class='col-md-6'>
                    <label class='form-label'>Тип торгов</label>
                    <div class='d-flex flex-wrap gap-3'>
                        <label class='form-check-label'><input class='form-check-input' type='checkbox'
                                                               th:field='*{types}' value='44-ФЗ'> 44‑ФЗ</label>
                        <label class='form-check-label'><input class='form-check-input' type='checkbox'
                                                               th:field='*{types}' value='223-ФЗ'> 223‑ФЗ</label>
                        <label class='form-check-label'><input class='form-check-input' type='checkbox'
                                                               th:field='*{types}' value='615 ПП РФ'> 615 ПП РФ</label>
                    </div>
                </div>
                <div class='col-md-6'>
                    <label class='form-label'>Этап</label>
                    <div class='d-flex flex-wrap gap-3'>
                        <label class='form-check-label'><input class='form-check-input' type='checkbox'
                                                               th:field='*{stages}' value='Подача заявок'> Подача заявок</label>
                        <label class='form-check-label'><input class='form-check-input' type='checkbox'
                                                               th:field='*{stages}' value='Работа комиссии'>
                            Работа комиссии</label>
                        <label class='form-check-label'><input class='form-check-input' type='checkbox'
                                                               th:field='*{stages}' value='Закупка завершена'>
                            Закупка завершена</label>
                        <label class='form-check-label'><input class='form-check-input' type='checkbox'
                                                               th:field='*{stages}' value='Закупка отменена'>
                            Закупка отменена</label>
                    </div>
                </div>
                <div class='col-md-4'>
                    <label class='form-label' for='pageSize'>Количество на странице</label>
                    <select id='pageSize' class='form-select' th:field='*{pageSize}'>
                        <option value='10'>10</option>
                        <option value='20'>20</option>
                        <option value='50'>50</option>
                    </select>
                </div>
                <div class='col-12 d-grid d-md-flex justify-content-md-end gap-3 pt-2'>
                    <button class='btn btn-primary px-5' type='submit'>Найти</button>
                </div>
            </div>
        </form>
        <!-- subscription and results sections omitted for brevity -->
        <form th:action="@{/tracking/subscribe}" method="post" th:object="${searchFormAttribute}">
            <input type="hidden" th:field="*{keyword}">
            <input type="hidden" th:field="*{stages}">
            <input type="hidden" th:field="*{types}">
            <input type="hidden" th:field="*{pageSize}">
            <input type="hidden"
                   th:if="${not #lists.isEmpty(searchResult.tenders)}"
                   name="purchaseCode"
                   th:value="${searchResult.tenders.get(0).purchaseCode}">

            <label for="interval">Проверять каждые:</label>
            <div class="form-group">
                <select id="interval" name="interval">
                    <option value="1">1 мин</option>
                    <option value="2">2 мин</option>
                    <option value="5">5 мин</option>
                </select>
            </div>

            <button type="submit" th:if="${not subscribe}" class="btn btn-primary">Отслеживать</button>
            <span th:if="${subscribe}" class="text-success">✓ Уже отслеживается</span>
        </form>
    </div>

    <br>

    <div class="search-form" th:if="${searchResult.totalCount > 0}">
        <h2>Результаты поиска</h2>
        <p th:text="'Найдено ' + ${searchResult.totalCount} + ' тендеров'"></p>
        <p th:text="'Страница ' + ${searchFormAttribute.currentPage} + ' из ' + ${searchResult.totalPages}"></p>

        <ul th:each="tender : ${searchResult.tenders}">
            <li>
                <span th:text="(${tender.title} != null ? ${tender.title} : '')"></span>
                <span th:text="'№ ' +  (${tender.purchaseCode} != null ? ${tender.purchaseCode} : '')"></span><br>
                <a th:href="${tender.link}" th:text="${tender.purchaseObject}" target="_blank"></a>
                <span th:text="(${tender.stage} != null ? ${tender.stage} : '')"></span><br>
                <span th:text="(${tender.author} != null ? ${tender.author} : '')"></span><br>
                <span th:text="'Цена: ' + (${tender.price} != null ? (${tender.price} + ' ' + ${tender.currency}) : '')"></span><br>
                <span th:text="'Размещено: ' + (${tender.postedDate} != null ? ${#temporals.format(tender.postedDate, 'dd.MM.yyyy')} : '')"></span>
                <span th:text="'Обновлено: ' + (${tender.updatedDate} != null ? ${#temporals.format(tender.updatedDate, 'dd.MM.yyyy')} : '')"></span>
                <span th:text="'Окончание подачи заявок: ' + (${tender.expirationDate} != null ? ${#temporals.format(tender.expirationDate, 'dd.MM.yyyy')} : '')"></span>
            </li>
        </ul>

        <form th:action="@{/api/search}" method="post" th:object="${searchFormAttribute}">
            <input type="hidden" th:field="*{keyword}">
            <input type="hidden" th:field="*{stages}">
            <input type="hidden" th:field="*{types}">
            <input type="hidden" th:field="*{pageSize}">

            <div class="pagination">
                <span th:each="pageNum : ${#numbers.sequence(1, searchResult.totalPages)}">
        <span th:if="${pageNum == 1 or pageNum == searchResult.totalPages
                      or (pageNum >= searchFormAttribute.currentPage - 2 and pageNum <= searchFormAttribute.currentPage + 2)}">

            <button type="submit"
                    th:attr="name='currentPage', value=${pageNum}"
                    th:classappend="${pageNum == searchFormAttribute.currentPage} ? 'btn btn-primary' : 'btn btn-light'">
                <span th:text="${pageNum}"></span>
            </button>
        </span>

        <span th:if="${(pageNum == searchFormAttribute.currentPage - 3) or (pageNum == searchFormAttribute.currentPage + 3)}"> ... </span>
                </span>
            </div>
        </form>
    </div>
</main>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'></script>
</body>
</html>